<?php
require_once 'config.php';
require_once 'session.php';

$product_id = $_GET['id'] ?? 0;
$quantity = $_GET['quantity'] ?? 1;

if ($product_id > 0) {
    $conn = getConnection();
    $session_id = getUserSessionId();
    
    // Cek apakah produk ada dan stok mencukupi
    $check_query = "SELECT stok FROM products WHERE id = ?";
    $stmt = $conn->prepare($check_query);
    $stmt->bind_param("i", $product_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($result->num_rows > 0) {
        $product = $result->fetch_assoc();
        
        if ($product['stok'] >= $quantity) {
            // Cek apakah produk sudah ada di cart
            $cart_check = "SELECT id, quantity FROM cart WHERE session_id = ? AND product_id = ?";
            $cart_stmt = $conn->prepare($cart_check);
            $cart_stmt->bind_param("si", $session_id, $product_id);
            $cart_stmt->execute();
            $cart_result = $cart_stmt->get_result();
            
            if ($cart_result->num_rows > 0) {
                // Update quantity
                $cart_item = $cart_result->fetch_assoc();
                $new_quantity = $cart_item['quantity'] + $quantity;
                
                if ($new_quantity <= $product['stok']) {
                    $update_query = "UPDATE cart SET quantity = ? WHERE id = ?";
                    $update_stmt = $conn->prepare($update_query);
                    $update_stmt->bind_param("ii", $new_quantity, $cart_item['id']);
                    $update_stmt->execute();
                    $update_stmt->close();
                    
                    $_SESSION['cart_message'] = 'Jumlah produk di keranjang berhasil diperbarui!';
                } else {
                    $_SESSION['cart_error'] = 'Stok tidak mencukupi!';
                }
            } else {
                // Insert new cart item
                $insert_query = "INSERT INTO cart (session_id, product_id, quantity) VALUES (?, ?, ?)";
                $insert_stmt = $conn->prepare($insert_query);
                $insert_stmt->bind_param("sii", $session_id, $product_id, $quantity);
                $insert_stmt->execute();
                $insert_stmt->close();
                
                $_SESSION['cart_message'] = 'Produk berhasil ditambahkan ke keranjang!';
            }
            
            $cart_stmt->close();
        } else {
            $_SESSION['cart_error'] = 'Stok tidak mencukupi!';
        }
    } else {
        $_SESSION['cart_error'] = 'Produk tidak ditemukan!';
    }
    
    $stmt->close();
    $conn->close();
}

// Redirect kembali
$redirect = $_SERVER['HTTP_REFERER'] ?? 'products.php';
header('Location: ' . $redirect);
exit;
?>