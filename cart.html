<?php
require_once 'config.php';
require_once 'session.php';

$conn = getConnection();
$session_id = getUserSessionId();

// Ambil item di cart
$query = "SELECT c.*, p.nama_produk, p.harga, p.gambar, p.stok 
          FROM cart c 
          JOIN products p ON c.product_id = p.id 
          WHERE c.session_id = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param("s", $session_id);
$stmt->execute();
$result = $stmt->get_result();

$cart_items = [];
$total = 0;

while ($row = $result->fetch_assoc()) {
    $subtotal = $row['harga'] * $row['quantity'];
    $row['subtotal'] = $subtotal;
    $total += $subtotal;
    $cart_items[] = $row;
}

// Ambil pesan jika ada
$message = $_SESSION['cart_message'] ?? '';
$error = $_SESSION['cart_error'] ?? '';
unset($_SESSION['cart_message']);
unset($_SESSION['cart_error']);

// Hitung jumlah item di cart
$cart_count = array_sum(array_column($cart_items, 'quantity'));
?>
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang Belanja - S&L Bags</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>S&L Bags</h1>
            </div>
            <ul class="nav-menu">
                <li><a href="index.php">Home</a></li>
                <li><a href="products.php">Produk</a></li>
                <li><a href="contact.php">Kontak</a></li>
                <li><a href="cart.php" class="cart-link active">
                    ðŸ›’ Keranjang <span class="cart-badge"><?php echo $cart_count; ?></span>
                </a></li>
                <li><a href="login.php" class="admin-link">Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Cart Section -->
    <div class="cart-container">
        <h2 class="section-title">Keranjang Belanja</h2>

        <?php if ($message): ?>
            <div class="alert alert-success"><?php echo htmlspecialchars($message); ?></div>
        <?php endif; ?>

        <?php if ($error): ?>
            <div class="alert alert-danger"><?php echo htmlspecialchars($error); ?></div>
        <?php endif; ?>

        <?php if (count($cart_items) > 0): ?>
        <div class="cart-items">
            <?php foreach ($cart_items as $item): ?>
            <div class="cart-item">
                <div class="cart-item-image">
                    <img src="uploads/<?php echo htmlspecialchars($item['gambar']); ?>" 
                         alt="<?php echo htmlspecialchars($item['nama_produk']); ?>"
                         onerror="this.src='https://via.placeholder.com/100'">
                </div>
                <div class="cart-item-info">
                    <h3><?php echo htmlspecialchars($item['nama_produk']); ?></h3>
                    <p>Harga: Rp <?php echo number_format($item['harga'], 0, ',', '.'); ?></p>
                    <p>Jumlah: <?php echo $item['quantity']; ?></p>
                    <p style="color: #999; font-size: 0.9rem;">Stok tersedia: <?php echo $item['stok']; ?></p>
                </div>
                <div class="cart-item-price">
                    <strong>Rp <?php echo number_format($item['subtotal'], 0, ',', '.'); ?></strong>
                </div>
                <div class="cart-item-actions">
                    <a href="remove_from_cart.php?id=<?php echo $item['id']; ?>" 
                       class="btn btn-danger"
                       onclick="return confirm('Hapus produk ini dari keranjang?')">Hapus</a>
                </div>
            </div>
            <?php endforeach; ?>
        </div>

        <div class="cart-summary">
            <h3>Ringkasan Belanja</h3>
            <div class="summary-row">
                <span>Subtotal (<?php echo $cart_count; ?> item)</span>
                <span>Rp <?php echo number_format($total, 0, ',', '.'); ?></span>
            </div>
            <div class="summary-row">
                <span>Ongkos Kirim</span>
                <span>Rp 0</span>
            </div>
            <div class="summary-row total">
                <span>Total</span>
                <span>Rp <?php echo number_format($total, 0, ',', '.'); ?></span>
            </div>
            <a href="contact.php" class="btn btn-success" style="width: 100%; margin-top: 1rem;">Lanjutkan ke Pemesanan</a>
            <a href="products.php" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">Lanjut Belanja</a>
        </div>
        <?php else: ?>
        <div class="empty-cart">
            <div class="empty-cart-icon">ðŸ›’</div>
            <h3>Keranjang Belanja Kosong</h3>
            <p>Anda belum menambahkan produk ke keranjang.</p>
            <a href="products.php" class="btn btn-primary">Mulai Belanja</a>
        </div>
        <?php endif; ?>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>S&L Bag Production</h3>
                    <p>Produsen tas berkualitas tinggi dengan desain modern dan material premium.</p>
                </div>
                <div class="footer-section">
                    <h3>Menu</h3>
                    <ul>
                        <li><a href="index.php">Home</a></li>
                        <li><a href="products.php">Produk</a></li>
                        <li><a href="contact.php">Kontak</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Kontak</h3>
                    <p>Email: info@slbags.com</p>
                    <p>Telp: 0857-2778-3875</p>
                    <p>WhatsApp: 0857-2778-3875</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 S&L Bag Production. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="script.js"></script>
</body>
</html>
<?php
$stmt->close();
$conn->close();
?>